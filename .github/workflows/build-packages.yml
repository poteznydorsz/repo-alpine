name: Build APK Packages

on:
  push:
    branches: [main]
    paths:
      - 'packages/**'
  workflow_dispatch:
  workflow_call:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64, aarch64, armv7]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Alpine Linux
        uses: jirutka/setup-alpine@v1
        with:
          arch: ${{ matrix.arch }}
          packages: >
            alpine-sdk
            sudo
      
      - name: Prepare build environment
        shell: alpine.sh {0}
        run: |
          sudo adduser -D builder
          sudo addgroup builder abuild
          sudo mkdir -p /etc/sudoers.d
          echo "builder ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/builder > /dev/null
          sudo chmod 0440 /etc/sudoers.d/builder
          sudo mkdir -p /var/cache/distfiles
          sudo chmod a+w /var/cache/distfiles

          # Create builder home directory with proper ownership
          sudo chown -R builder:builder /home/builder
          
          # Generate signing keys
          sudo -u builder abuild-keygen -a -i -n
      
      - name: Build packages
        shell: alpine.sh {0}
        run: |
          # Give builder user ownership of package directories
          sudo chown -R builder:builder packages/
          
          for pkg in packages/*/; do
            if [ -f "$pkg/APKBUILD" ]; then
              echo "==> Building $(basename $pkg) for ${{ matrix.arch }}"
              cd "$pkg"
              sudo -u builder PACKAGER="poteznydorsz" REPODEST=/home/builder abuild checksum || true
              sudo -u builder PACKAGER="poteznydorsz" REPODEST=/home/builder abuild -r || echo "Failed to build $(basename $pkg)"
              cd -
            fi
          done
      
      - name: Create repository index
        shell: alpine.sh {0}
        run: |
          mkdir -p repo/${{ matrix.arch }}
          
          # Only proceed if packages were built
          if [ -d "/home/builder/packages/${{ matrix.arch }}" ]; then
            find /home/builder/packages/${{ matrix.arch }}/ -name '*.apk' -exec cp {} repo/${{ matrix.arch }}/ \; || true
          fi
          
          if [ -n "$(ls -A repo/${{ matrix.arch }}/*.apk 2>/dev/null)" ]; then
            # Give builder ownership of repo directory for signing
            sudo chown -R builder:builder repo/
            cd repo/${{ matrix.arch }}
            apk index -o APKINDEX.tar.gz *.apk
            sudo -u builder abuild-sign APKINDEX.tar.gz
            cd -
            # Change ownership back if needed for upload
            sudo chown -R $(whoami):$(whoami) repo/
          fi
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.arch }}
          path: repo/${{ matrix.arch }}/
          retention-days: 90
  
  publish:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: repo-temp
      
      - name: Organize repository structure
        run: |
          mkdir -p public
          for arch_dir in repo-temp/packages-*; do
            arch=$(basename $arch_dir | sed 's/packages-//')
            mkdir -p public/$arch
            cp -r $arch_dir/* public/$arch/ || true
          done
          
          # Create a simple index.html
          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Alpine APK Repository</title>
              <style>
                  body { font-family: sans-serif; max-width: 800px; margin: 50px auto; }
                  pre { background: #f4f4f4; padding: 15px; border-radius: 5px; }
                  code { background: #f4f4f4; padding: 2px 5px; border-radius: 3px; }
              </style>
          </head>
          <body>
              <h1>Alpine Linux APK Repository</h1>
              <h2>Available Packages</h2>
              <ul>
                  <li>livekit-server</li>
                  <li>lk-jwt-service</li>
              </ul>
              
              <h2>Usage</h2>
              <p>Add this repository to your Alpine Linux system:</p>
              <pre><code>echo "https://poteznydorsz.github.io/repo-alpine/$(uname -m)" | sudo tee -a /etc/apk/repositories
              sudo apk update
              sudo apk add livekit-server lk-jwt-service</code></pre>
              <h2>Architecture Support</h2>
              <ul>
                  <li><a href="x86_64/">x86_64</a></li>
                  <li><a href="aarch64/">aarch64</a></li>
                  <li><a href="armv7/">armv7</a></li>
                </ul>
          </body>
          </html>
          EOF
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
